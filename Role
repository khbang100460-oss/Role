<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²­ì†Œ ë° 1ì¸ 1ì—­ ëœë¤ ìƒì„±ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .draggable {
            cursor: move;
            user-select: none;
        }
        .drop-zone {
            min-height: 50px;
            border: 2px dashed #ccc;
            transition: background-color 0.3s;
        }
        .drag-over {
            background-color: #e0e7ff;
        }
        .student-tag {
            transition: all 0.2s ease-in-out;
        }
        .student-tag:hover {
            transform: scale(1.05);
        }
        /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">ì²­ì†Œ ë° 1ì¸ 1ì—­ ëœë¤ ìƒì„±ê¸°</h1>
            <p class="text-gray-500 mt-2">ì—­í• ê³¼ í•™ìƒì„ ì„¤ì •í•˜ê³  ë²„íŠ¼ í•˜ë‚˜ë¡œ ì—­í• ì„ ë°°ì •í•˜ì„¸ìš”!</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- ì„¤ì • íŒ¨ë„ -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3">âš™ï¸ ì„¤ì •</h2>

                <!-- í•™ìƒ ê´€ë¦¬ -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">1. í•™ìƒ ëª…ë‹¨ ê´€ë¦¬</h3>
                    <div class="flex flex-col gap-2">
                        <textarea id="studentNames" class="flex-grow p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" rows="3" placeholder="í•™ìƒ ì´ë¦„ì„ ì‰¼í‘œ(,) ë˜ëŠ” ë„ì–´ì“°ê¸°ë¡œ êµ¬ë¶„í•˜ì—¬ í•œ ë²ˆì— ì…ë ¥í•˜ì„¸ìš”."></textarea>
                        <button id="addStudentsBtn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition w-full">ëª…ë‹¨ì— ì¶”ê°€</button>
                    </div>
                    <div id="studentList" class="mt-3 flex flex-wrap gap-2 p-3 bg-slate-100 rounded-lg min-h-[60px]">
                        <!-- í•™ìƒ íƒœê·¸ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- ì—­í•  ê´€ë¦¬ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                         <h3 class="text-lg font-semibold">2. ì—­í•  ê´€ë¦¬</h3>
                         <div id="totalCountDisplay" class="font-semibold text-gray-600 text-sm text-right">
                            <!-- ì´ ì¸ì› ì§‘ê³„ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. -->
                        </div>
                    </div>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="roleName" class="w-1/2 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="ì—­í•  ì´ë¦„">
                        <input type="number" id="roleCount" class="w-1/4 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-400" placeholder="ì¸ì›" min="1" value="1">
                        <button id="addRoleBtn" class="flex-grow bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition">ì—­í•  ì¶”ê°€</button>
                    </div>
                    <div id="manualRoleList" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                        <!-- ìˆ˜ë™ ì¶”ê°€ ì—­í•  ëª©ë¡ -->
                    </div>
                    
                     <div class="border-t pt-4 mt-4">
                        <h4 class="text-md font-semibold mb-2 text-gray-700">ì—­í•  ìë™ ì¶”ì²œ</h4>
                         <p class="text-sm text-gray-500 mb-3">ğŸ’¡ **Tip:** ì¶”ì²œëœ ì—­í• ì„ í´ë¦­í•˜ë©´ ìœ„ ì…ë ¥ ì¹¸ì— ë‚´ìš©ì´ ì±„ì›Œì§‘ë‹ˆë‹¤. ìˆ˜ì • í›„ 'ì—­í•  ì¶”ê°€' ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª©ë¡ì— ë“±ë¡í•˜ì„¸ìš”.</p>
                        <div class="flex gap-2 mb-3">
                            <input type="number" id="recommendStudentCount" class="w-1/2 p-2 border rounded-lg focus:ring-2 focus:ring-green-400" placeholder="ì¶”ì²œë°›ì„ ì´ í•™ìƒ ìˆ˜ (ì˜ˆ: 32)">
                             <button id="recommendCleaning" class="flex-grow bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition whitespace-nowrap">ğŸ§¹ ì²­ì†Œ</button>
                            <button id="recommendIndividual" class="flex-grow bg-sky-500 text-white px-4 py-2 rounded-lg hover:bg-sky-600 transition whitespace-nowrap">ğŸ™‹ 1ì¸ 1ì—­</button>
                        </div>
                    </div>
                    <div id="recommendedRoleList" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                        <!-- ì¶”ì²œ ì—­í•  ëª©ë¡ -->
                    </div>
                </div>

                <!-- ê°™ì´ ë°°ì •ë˜ë©´ ì•ˆë˜ëŠ” í•™ìƒ -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3">3. ì œì™¸ ì¡°ê±´ ì„¤ì •</h3>
                    <div class="flex gap-2 items-center">
                        <select id="excludeStudent1" class="flex-grow p-2 border rounded-lg bg-white"></select>
                        <span class="font-bold">ì™€(ê³¼)</span>
                        <select id="excludeStudent2" class="flex-grow p-2 border rounded-lg bg-white"></select>
                        <button id="addExclusionBtn" class="bg-amber-500 text-white px-4 py-2 rounded-lg hover:bg-amber-600 transition">ì¡°ê±´ ì¶”ê°€</button>
                    </div>
                    <div id="exclusionList" class="mt-3 flex flex-wrap gap-2 p-3 bg-slate-100 rounded-lg min-h-[40px]">
                        <!-- ì œì™¸ ì¡°ê±´ íƒœê·¸ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                
                <!-- ì‹¤í–‰ ë²„íŠ¼ -->
                <div>
                    <button id="generateBtn" class="w-full bg-red-500 text-white text-lg font-bold py-3 rounded-lg hover:bg-red-600 transition transform hover:scale-105">âœ¨ ì—­í•  ëœë¤ ë°°ì • ì‹¤í–‰! âœ¨</button>
                </div>
            </div>

            <!-- ê²°ê³¼ íŒ¨ë„ -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-2xl font-bold">ğŸ“Š ë°°ì • ê²°ê³¼</h2>
                    <button id="exportCsvBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition flex items-center gap-2">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 2.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" />
                        </svg>
                        ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸° (CSV)
                    </button>
                </div>
                <div id="resultArea" class="space-y-4 max-h-[80vh] overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center py-10">ì„¤ì •ì„ ì™„ë£Œí•˜ê³  'ì—­í•  ëœë¤ ë°°ì • ì‹¤í–‰' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>
        
        <!-- ëª¨ë‹¬ ì°½ -->
        <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-sm w-full">
                <p id="modalMessage" class="text-lg mb-6"></p>
                <button id="closeModalBtn" class="bg-indigo-500 text-white px-6 py-2 rounded-lg hover:bg-indigo-600 transition">í™•ì¸</button>
            </div>
        </div>
        
        <!-- í™•ì¸ ëª¨ë‹¬ ì°½ -->
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-sm w-full">
                <p id="confirmMessage" class="text-lg mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="confirmYesBtn" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition">ì˜ˆ</button>
                    <button id="confirmNoBtn" class="bg-gray-300 px-6 py-2 rounded-lg hover:bg-gray-400 transition">ì•„ë‹ˆìš”</button>
                </div>
            </div>
        </div>

        <!-- CSV ë‚´ë³´ë‚´ê¸° ëª¨ë‹¬ -->
        <div id="csvModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-2xl text-left max-w-md w-full">
                <h3 class="text-xl font-bold mb-4">ì—‘ì…€ ë°ì´í„° ë³µì‚¬í•˜ê¸°</h3>
                <p class="text-gray-600 mb-4">ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ ì—‘ì…€ ì‹œíŠ¸ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p>
                <textarea id="csvOutput" class="w-full h-40 p-2 border rounded-lg bg-gray-50 font-mono text-sm" readonly></textarea>
                <div class="flex justify-end gap-4 mt-4">
                    <button id="copyCsvBtn" class="bg-indigo-500 text-white px-6 py-2 rounded-lg hover:bg-indigo-600 transition">ë³µì‚¬í•˜ê¸°</button>
                    <button id="closeCsvModalBtn" class="bg-gray-300 px-6 py-2 rounded-lg hover:bg-gray-400 transition">ë‹«ê¸°</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- ìƒíƒœ ê´€ë¦¬ ë° ë°ì´í„° ---
        let students = []; // í•™ìƒ ëª©ë¡. ë™ëª…ì´ì¸ì€ 'ì´ë¦„_2', 'ì´ë¦„_3' ë“±ìœ¼ë¡œ ì €ì¥
        let roles = []; // ì—­í•  ëª©ë¡. {name, count, recommended: boolean}
        let exclusions = [];
        let assignments = {};

        const CLEANING_ROLE_POOL = ['êµì‹¤ ë°”ë‹¥ ì“¸ê¸°', 'ë³µë„ ì“¸ê¸°', 'ë¶„ë¦¬ìˆ˜ê±°', 'ì°½í‹€ ë‹¦ê¸°', 'ì¹ íŒ ì§€ìš°ê¸°', 'ì“°ë ˆê¸°í†µ ë¹„ìš°ê¸°', 'ê²Œì‹œíŒ ê´€ë¦¬', 'ì‚¬ë¬¼í•¨ ìœ„ ë¨¼ì§€ ë‹¦ê¸°', 'êµêµ¬ì¥ ì •ë¦¬', 'ë³µë„ ê±¸ë ˆì§ˆ', 'íŠ¹ë³„êµ¬ì—­ ì²­ì†Œ', 'ì‹ ë°œì¥ ì •ë¦¬', 'ê³„ë‹¨ ì²­ì†Œ', 'í™”ë¶„ ê´€ë¦¬', 'ì»´í“¨í„° ì±…ìƒ ì •ë¦¬', 'ë¬¸ ì†ì¡ì´ ì†Œë…', 'ì¹ íŒí‹€ ë‹¦ê¸°', 'ì°½ë¬¸ ë‹¦ê¸°', 'ê±°ë¯¸ì¤„ ì œê±°', 'ì±…ìƒ ì¤„ ë§ì¶”ê¸°', 'ì˜ì ë„£ê¸°', 'ì¬í™œìš©í’ˆ ë¼ë²¨ ì œê±°', 'ë°”ë‹¥ ìŠ¤í‹°ì»¤ ì œê±°', 'ê³µê¸°ì²­ì •ê¸° í•„í„° ê´€ë¦¬', 'ì†Œë… í‹°ìŠˆë¡œ ì±…ìƒ ë‹¦ê¸°'];
        const INDIVIDUAL_ROLE_POOL = ['ìš°ìœ  ë‹¹ë²ˆ', 'ìˆ™ì œ ê±·ê¸°', '1ë¶„ ìŠ¤í”¼ì¹˜ ë„ìš°ë¯¸', 'ì‹ë¬¼ ê´€ë¦¬', 'ë©€í‹°ë¯¸ë””ì–´ ë‹´ë‹¹', 'ì•Œë¦¼ì¥ ë„ìš°ë¯¸', 'ì¤„ë°˜ì¥', 'ë„ì„œë¶€ì¥', 'ìš°í¸ë¬¼ ë‹´ë‹¹', 'í–‰ì‚¬ ë„ìš°ë¯¸', 'ì—ë„ˆì§€ ì§€í‚´ì´', 'ë˜ë˜ ìƒë‹´ì‚¬', 'ì•„ì¹¨í™œë™ ë„ìš°ë¯¸', 'ì²´ìœ¡ë¶€ì¥', 'ê¸°ìì¬ ë‹´ë‹¹', 'ìƒì¼ ì¶•í•˜ ë„ìš°ë¯¸', 'ì¹­ì°¬ ë°°ë‹¬ë¶€', 'ë¶„ì‹¤ë¬¼ ë‹´ë‹¹', 'ì‹œê°„ ì•Œë¦¬ë¯¸', 'í•™ìŠµ ìë£Œ ë°°ë¶€ ë„ìš°ë¯¸', 'ê±·ê¸° ë„ìš°ë¯¸', 'ê¸‰ì‹ ë„ìš°ë¯¸', 'ì¹­ì°¬ ìƒ¤ì›Œ ì§„í–‰ì', 'í•™ê¸‰ íšŒì˜ ì„œê¸°', 'ë¯¸ë””ì–´ ë¹„í‰ê°€', 'ì˜¤ëŠ˜ì˜ ë‰´ìŠ¤ ì „ë‹¬ì', 'ê±´ê°• ì§€í‚´ì´', 'ë§ˆë‹ˆë˜ ì§€í‚´ì´', 'íƒ€ì„ìº¡ìŠ ê´€ë¦¬ì', 'ìš°ë¦¬ ë°˜ DJ', 'ì´ë‹¬ì˜ ë…ì„œì™•', 'ì°½ì˜ë ¥ ëŒ€ì¥', 'ìœ ë¨¸ ë‹´ë‹¹', 'ê³ ë¯¼ í•´ê²°ì‚¬', 'ì ˆì•½ì˜ ì‹ '];

        // --- DOM ìš”ì†Œ ---
        const studentNamesInput = document.getElementById('studentNames');
        const addStudentsBtn = document.getElementById('addStudentsBtn');
        const studentListDiv = document.getElementById('studentList');
        
        const roleNameInput = document.getElementById('roleName');
        const roleCountInput = document.getElementById('roleCount');
        const addRoleBtn = document.getElementById('addRoleBtn');
        const manualRoleListDiv = document.getElementById('manualRoleList');
        const recommendedRoleListDiv = document.getElementById('recommendedRoleList');

        const recommendStudentCountInput = document.getElementById('recommendStudentCount');
        const recommendCleaningBtn = document.getElementById('recommendCleaning');
        const recommendIndividualBtn = document.getElementById('recommendIndividual');

        const excludeStudent1Select = document.getElementById('excludeStudent1');
        const excludeStudent2Select = document.getElementById('excludeStudent2');
        const addExclusionBtn = document.getElementById('addExclusionBtn');
        const exclusionListDiv = document.getElementById('exclusionList');
        
        const generateBtn = document.getElementById('generateBtn');
        const resultArea = document.getElementById('resultArea');

        const totalCountDisplay = document.getElementById('totalCountDisplay');
        
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const csvModal = document.getElementById('csvModal');
        const csvOutput = document.getElementById('csvOutput');
        const copyCsvBtn = document.getElementById('copyCsvBtn');
        const closeCsvModalBtn = document.getElementById('closeCsvModalBtn');

        const alertModal = document.getElementById('alertModal');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalBtn = document.getElementById('closeModalBtn');

        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        // --- í•¨ìˆ˜ ---

        function showAlert(message) {
            modalMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }

        function showConfirm(message) {
            return new Promise((resolve) => {
                confirmMessage.textContent = message;
                confirmModal.classList.remove('hidden');

                confirmYesBtn.onclick = () => {
                    confirmModal.classList.add('hidden');
                    resolve(true);
                };
                confirmNoBtn.onclick = () => {
                    confirmModal.classList.add('hidden');
                    resolve(false);
                };
            });
        }
        
        function getBaseName(student) {
            return student.split('_')[0];
        }

        function updateCounts() {
            const totalRoleCount = roles.reduce((sum, role) => sum + role.count, 0);
            totalCountDisplay.innerHTML = `ì´ <span class="text-indigo-600 font-bold">${totalRoleCount}</span> / <span class="text-blue-600 font-bold">${students.length}</span> ëª…`;
        }

        function renderStudents() {
            const nameCounts = students.reduce((acc, student) => {
                const baseName = getBaseName(student);
                acc[baseName] = (acc[baseName] || 0) + 1;
                return acc;
            }, {});

            studentListDiv.innerHTML = '';
            students.forEach((student) => {
                const baseName = getBaseName(student);
                const isDuplicate = nameCounts[baseName] > 1;

                const tag = document.createElement('span');
                tag.className = 'bg-blue-200 text-blue-800 px-3 py-1 rounded-full text-sm font-medium flex items-center gap-2';
                
                let displayName = baseName;
                if (isDuplicate) {
                    displayName += ` <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>`;
                }

                tag.innerHTML = `${displayName} <button data-id="${student}" class="remove-student text-blue-600 hover:text-blue-900 font-bold">x</button>`;
                studentListDiv.appendChild(tag);
            });
            updateExclusionDropdowns();
            updateCounts();
        }

        async function addStudents() {
            const namesString = studentNamesInput.value.trim();
            if (!namesString) return;

            const names = namesString.replace(/,/g, ' ').split(/\s+/).filter(name => name.length > 0);
            
            for (const name of names) {
                const baseName = getBaseName(name);
                const existingStudents = students.filter(s => getBaseName(s) === baseName);

                if (existingStudents.length > 0) {
                    const confirmed = await showConfirm(`'${baseName}' í•™ìƒì€ ì´ë¯¸ ëª…ë‹¨ì— ìˆìŠµë‹ˆë‹¤. ë™ëª…ì´ì¸ìœ¼ë¡œ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                    if (confirmed) {
                        const newSuffix = existingStudents.length + 1;
                        students.push(`${baseName}_${newSuffix}`);
                    }
                } else {
                    students.push(baseName);
                }
            }
            
            renderStudents();
            studentNamesInput.value = '';
            studentNamesInput.focus();
        }

        function removeStudent(studentId) {
            students = students.filter(s => s !== studentId);
            exclusions = exclusions.filter(ex => ex.student1 !== studentId && ex.student2 !== studentId);
            renderStudents();
            renderExclusions();
        }

        function renderRoles() {
            manualRoleListDiv.innerHTML = '';
            recommendedRoleListDiv.innerHTML = '';

            roles.forEach((role, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-slate-100 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium role-name-span cursor-pointer hover:text-indigo-600 transition-colors" data-index="${index}">
                        ${role.name}
                    </span>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-600">${role.count}ëª…</span>
                        <button data-index="${index}" class="remove-role bg-red-200 text-red-700 px-2 py-1 rounded hover:bg-red-300 text-xs">ì‚­ì œ</button>
                    </div>
                `;
                if (role.recommended) {
                    recommendedRoleListDiv.appendChild(div);
                } else {
                    manualRoleListDiv.appendChild(div);
                }
            });
            updateCounts();
        }

        function addRole() {
            const name = roleNameInput.value.trim();
            const count = parseInt(roleCountInput.value, 10);
            if (name && count > 0) {
                if (roles.some(role => role.name === name)) {
                    showAlert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì—­í•  ì´ë¦„ì…ë‹ˆë‹¤.');
                    return;
                }
                roles.push({ name, count, recommended: false });
                renderRoles();
                roleNameInput.value = '';
                roleCountInput.value = '1';
            }
            roleNameInput.focus();
        }
        
        function removeRole(index) {
            roles.splice(index, 1);
            renderRoles();
        }

        function recommendRolesFromPool(type) {
            let totalStudents = parseInt(recommendStudentCountInput.value, 10);
            if (isNaN(totalStudents) || totalStudents <= 0) {
                showAlert('ì¶”ì²œë°›ì„ ì´ í•™ìƒ ìˆ˜ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            roles = roles.filter(role => !role.recommended);
            const existingRoleNames = new Set(roles.map(r => r.name));
            const rolePool = (type === 'cleaning' ? CLEANING_ROLE_POOL : INDIVIDUAL_ROLE_POOL)
                .filter(name => !existingRoleNames.has(name));

            for (let i = rolePool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [rolePool[i], rolePool[j]] = [rolePool[j], rolePool[i]];
            }

            const recommendedRoles = [];
            let assignedCount = roles.reduce((sum, role) => sum + role.count, 0);
            let poolIndex = 0;

            while (assignedCount < totalStudents && poolIndex < rolePool.length) {
                const roleName = rolePool[poolIndex];
                let count = (totalStudents - assignedCount >= 2 && Math.random() > 0.3) ? 2 : 1;
                
                recommendedRoles.push({ name: roleName, count, recommended: true });
                assignedCount += count;
                poolIndex++;
            }

            const excess = assignedCount - totalStudents;
            if (excess > 0 && recommendedRoles.length > 0) {
                const lastRole = recommendedRoles[recommendedRoles.length - 1];
                if (lastRole.count > excess) {
                    lastRole.count -= excess;
                } else {
                    recommendedRoles.pop();
                }
            }

            roles.push(...recommendedRoles);
            renderRoles();
        }

        function updateExclusionDropdowns() {
            const options = students.map(s => `<option value="${s}">${getBaseName(s)}</option>`).join('');
            excludeStudent1Select.innerHTML = options;
            excludeStudent2Select.innerHTML = options;
        }

        function renderExclusions() {
            exclusionListDiv.innerHTML = '';
            exclusions.forEach((ex, index) => {
                const tag = document.createElement('span');
                tag.className = 'bg-yellow-200 text-yellow-800 px-3 py-1 rounded-full text-sm font-medium flex items-center gap-2';
                tag.innerHTML = `(${getBaseName(ex.student1)}, ${getBaseName(ex.student2)}) <button data-index="${index}" class="remove-exclusion text-yellow-600 hover:text-yellow-900 font-bold">x</button>`;
                exclusionListDiv.appendChild(tag);
            });
        }

        function addExclusion() {
            const s1 = excludeStudent1Select.value;
            const s2 = excludeStudent2Select.value;
            if (s1 && s2 && s1 !== s2) {
                const newExclusion = { student1: s1, student2: s2 };
                const reversedExclusion = { student1: s2, student2: s1 };
                const exists = exclusions.some(ex => 
                    (ex.student1 === newExclusion.student1 && ex.student2 === newExclusion.student2) ||
                    (ex.student1 === reversedExclusion.student1 && ex.student2 === reversedExclusion.student2)
                );
                if (!exists) {
                    exclusions.push(newExclusion);
                    renderExclusions();
                } else { showAlert('ì´ë¯¸ ë“±ë¡ëœ ì œì™¸ ì¡°ê±´ì…ë‹ˆë‹¤.'); }
            } else if (s1 === s2) { showAlert('ì„œë¡œ ë‹¤ë¥¸ í•™ìƒì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.'); }
        }
        
        function removeExclusion(index) {
            exclusions.splice(index, 1);
            renderExclusions();
        }

        function generateAssignments() {
            const totalRolesCount = roles.reduce((sum, role) => sum + role.count, 0);
            if (students.length === 0) { showAlert('í•™ìƒ ëª…ë‹¨ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.'); return; }
            if (roles.length === 0) { showAlert('ì—­í• ì„ ë¨¼ì € ì¶”ê°€í•´ì£¼ì„¸ìš”.'); return; }
            if (students.length < totalRolesCount) { showAlert(`í•™ìƒ ìˆ˜(${students.length}ëª…)ê°€ ì—­í• ì˜ ì´ ì¸ì›(${totalRolesCount}ëª…)ë³´ë‹¤ ì ìŠµë‹ˆë‹¤.`); return; }

            let attempt = 0;
            while (attempt < 100) {
                let shuffledStudents = [...students].sort(() => 0.5 - Math.random());
                let tempAssignments = {};
                roles.forEach(role => tempAssignments[role.name] = []);
                
                let currentStudentIndex = 0;
                let success = true;
                for (const role of roles) {
                    for (let i = 0; i < role.count; i++) {
                        if (currentStudentIndex < shuffledStudents.length) {
                            tempAssignments[role.name].push(shuffledStudents[currentStudentIndex++]);
                        } else { success = false; break; }
                    }
                    if (!success) break;
                }
                if (!success) continue;

                let isValid = true;
                for (const roleName in tempAssignments) {
                    const assignedStudents = tempAssignments[roleName];
                    for (const exclusion of exclusions) {
                        if (assignedStudents.includes(exclusion.student1) && assignedStudents.includes(exclusion.student2)) {
                            isValid = false; break;
                        }
                    }
                    if (!isValid) break;
                }

                if (isValid) {
                    assignments = tempAssignments;
                    const assignedStudentsSet = new Set(Object.values(assignments).flat());
                    const unassignedStudents = students.filter(s => !assignedStudentsSet.has(s));
                    if (unassignedStudents.length > 0) {
                        assignments['ë¬´ì†Œì†'] = unassignedStudents;
                    }
                    renderResults();
                    return;
                }
                attempt++;
            }
            showAlert('ì œì™¸ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¡°í•©ì„ ì°¾ê¸° ì–´ë µìŠµë‹ˆë‹¤. ì¡°ê±´ì„ ë³€ê²½í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }

        function renderResults() {
            resultArea.innerHTML = '';
            for (const roleName in assignments) {
                const roleDiv = document.createElement('div');
                roleDiv.className = 'p-4 rounded-lg';
                roleDiv.style.backgroundColor = roleName === 'ë¬´ì†Œì†' ? '#f1f5f9' : '#eef2ff';
                const title = document.createElement('h4');
                title.className = 'text-lg font-bold mb-3';
                title.textContent = roleName;
                roleDiv.appendChild(title);
                const studentContainer = document.createElement('div');
                studentContainer.className = 'flex flex-wrap gap-2 drop-zone';
                studentContainer.dataset.role = roleName;
                assignments[roleName].forEach(studentId => {
                    const studentTag = document.createElement('span');
                    studentTag.className = 'student-tag draggable bg-white px-4 py-2 rounded-lg shadow-sm font-semibold';
                    studentTag.textContent = getBaseName(studentId);
                    studentTag.draggable = true;
                    studentTag.dataset.student = studentId;
                    studentContainer.appendChild(studentTag);
                });
                roleDiv.appendChild(studentContainer);
                resultArea.appendChild(roleDiv);
            }
        }

        function generateCsv() {
            if (Object.keys(assignments).length === 0) {
                showAlert('ë¨¼ì € ì—­í• ì„ ë°°ì •í•´ì£¼ì„¸ìš”.');
                return;
            }

            let csvContent = "ì—­í• \tì´ë¦„\n"; // íƒ­ìœ¼ë¡œ êµ¬ë¶„

            const tableData = Object.entries(assignments).map(([role, students]) => {
                const sortedStudents = students.map(getBaseName).sort((a, b) => a.localeCompare(b, 'ko-KR')).join(', ');
                return `${role}\t${sortedStudents}`;
            }).join("\n");
            
            csvContent += tableData;

            csvOutput.value = csvContent;
            csvModal.classList.remove('hidden');
        }
        
        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        addStudentsBtn.addEventListener('click', addStudents);
        studentNamesInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addStudents(); } });
        studentListDiv.addEventListener('click', (e) => { 
            const removeBtn = e.target.closest('.remove-student');
            if (removeBtn) removeStudent(removeBtn.dataset.id); 
        });
        addRoleBtn.addEventListener('click', addRole);
        roleNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addRole(); });
        roleCountInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addRole(); });
        
        function handleRoleListClick(e) {
            const target = e.target;
            const removeBtn = target.closest('.remove-role');
            if (removeBtn) {
                const index = parseInt(removeBtn.dataset.index, 10);
                roles.splice(index, 1);
                renderRoles();
                return;
            }
            const roleNameSpan = target.closest('.role-name-span');
            if (roleNameSpan) {
                const index = parseInt(roleNameSpan.dataset.index, 10);
                const roleToEdit = roles[index];

                roleNameInput.value = roleToEdit.name;
                roleCountInput.value = roleToEdit.count;
                roleNameInput.focus();

                roles.splice(index, 1);
                renderRoles();
            }
        }
        manualRoleListDiv.addEventListener('click', handleRoleListClick);
        recommendedRoleListDiv.addEventListener('click', handleRoleListClick);
        
        recommendCleaningBtn.addEventListener('click', () => recommendRolesFromPool('cleaning'));
        recommendIndividualBtn.addEventListener('click', () => recommendRolesFromPool('individual'));
        addExclusionBtn.addEventListener('click', addExclusion);
        exclusionListDiv.addEventListener('click', (e) => { if (e.target.classList.contains('remove-exclusion')) removeExclusion(e.target.dataset.index); });
        generateBtn.addEventListener('click', generateAssignments);
        closeModalBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
        
        exportCsvBtn.addEventListener('click', (e) => {
            e.preventDefault();
            generateCsv();
        });

        copyCsvBtn.addEventListener('click', () => {
            csvOutput.select();
            document.execCommand('copy');
            showAlert('ì—‘ì…€ ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì—‘ì…€ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
            csvModal.classList.add('hidden');
        });

        closeCsvModalBtn.addEventListener('click', () => {
            csvModal.classList.add('hidden');
        });
        
        let draggedItem = null;
        resultArea.addEventListener('dragstart', (e) => { if (e.target.classList.contains('draggable')) { draggedItem = e.target; setTimeout(() => { e.target.style.opacity = '0.5'; }, 0); } });
        resultArea.addEventListener('dragend', (e) => { if (draggedItem) { setTimeout(() => { draggedItem.style.opacity = '1'; draggedItem = null; }, 0); } });
        resultArea.addEventListener('dragover', (e) => { e.preventDefault(); const dropZone = e.target.closest('.drop-zone'); if(dropZone) { document.querySelectorAll('.drop-zone').forEach(dz => dz.classList.remove('drag-over')); dropZone.classList.add('drag-over'); } });
        resultArea.addEventListener('dragleave', (e) => { const dropZone = e.target.closest('.drop-zone'); if(dropZone) dropZone.classList.remove('drag-over'); });
        resultArea.addEventListener('drop', (e) => { e.preventDefault(); document.querySelectorAll('.drop-zone').forEach(dz => dz.classList.remove('drag-over')); if (!draggedItem) return; const dropZone = e.target.closest('.drop-zone'); if (dropZone) { const targetItem = e.target.closest('.draggable'); if (targetItem && targetItem !== draggedItem) { const originZone = draggedItem.parentElement; const targetZone = targetItem.parentElement; targetZone.insertBefore(draggedItem, targetItem.nextSibling); originZone.insertBefore(targetItem, null); } else { dropZone.appendChild(draggedItem); } updateAssignmentsData(); } });

        function updateAssignmentsData() {
            const newAssignments = {};
            document.querySelectorAll('.drop-zone').forEach(zone => { const role = zone.dataset.role; const studentsInRole = []; zone.querySelectorAll('.draggable').forEach(studentEl => studentsInRole.push(studentEl.dataset.student)); newAssignments[role] = studentsInRole; });
            let isValid = true; let conflictRole = '';
            for (const roleName in newAssignments) { const assignedStudents = newAssignments[roleName]; for (const exclusion of exclusions) { if (assignedStudents.includes(exclusion.student1) && assignedStudents.includes(exclusion.student2)) { isValid = false; conflictRole = roleName; break; } } if (!isValid) break; }
            if(isValid) { assignments = newAssignments; } else { showAlert(`"${conflictRole}" ì—­í• ì— í•¨ê»˜ ìˆì„ ìˆ˜ ì—†ëŠ” í•™ìƒì´ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë³€ê²½ì´ ì·¨ì†Œë©ë‹ˆë‹¤.`); renderResults(); }
        }

        // --- ì´ˆê¸°í™” ---
        renderStudents();
        renderRoles();
    </script>
</body>
</html>

